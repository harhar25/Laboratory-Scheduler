<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">Notifications</h1>
        <div class="btn-group">
            <button class="btn btn-outline-primary" onclick="refreshNotifications()">
                <i class="fas fa-sync-alt me-1"></i>Refresh
            </button>
            <button class="btn btn-outline-success" onclick="markAllAsRead()">
                <i class="fas fa-check-double me-1"></i>Mark All Read
            </button>
            <button class="btn btn-outline-danger" onclick="clearAllNotifications()">
                <i class="fas fa-trash me-1"></i>Clear All
            </button>
        </div>
    </div>

    <!-- Notification Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3 align-items-center">
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" class="form-control" id="notificationSearch" 
                               placeholder="Search notifications..." onkeyup="searchNotifications(this.value)">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="btn-group w-100">
                        <button type="button" class="btn btn-outline-primary active notification-filter-btn" 
                                data-filter="all" onclick="filterNotifications('all')">
                            All
                        </button>
                        <button type="button" class="btn btn-outline-warning notification-filter-btn" 
                                data-filter="unread" onclick="filterNotifications('unread')">
                            Unread
                        </button>
                        <button type="button" class="btn btn-outline-success notification-filter-btn" 
                                data-filter="read" onclick="filterNotifications('read')">
                            Read
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notifications List -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Your Notifications</h5>
            <span class="badge bg-primary" id="notificationCount">
                {{ notifications|length }} total
            </span>
        </div>
        <div class="card-body p-0">
            <div id="notificationList">
                {% if notifications %}
                <div class="list-group list-group-flush">
                    {% for notification in notifications %}
                    <div class="list-group-item notification-item {% if not notification.is_read %}unread{% endif %}" 
                         data-notification-id="{{ notification.id }}"
                         data-notification-type="{{ notification.type }}">
                        <div class="d-flex w-100 justify-content-between align-items-start">
                            <div class="flex-grow-1 me-3">
                                <div class="d-flex align-items-center mb-1">
                                    <h6 class="mb-0 {% if not notification.is_read %}fw-bold{% endif %}">
                                        {{ notification.title }}
                                    </h6>
                                    {% if not notification.is_read %}
                                    <span class="badge bg-warning ms-2">New</span>
                                    {% endif %}
                                </div>
                                <p class="mb-1 text-muted">{{ notification.message }}</p>
                                <div class="d-flex align-items-center mt-2">
                                    <small class="text-muted me-3">
                                        <i class="fas fa-clock me-1"></i>
                                        {{ notification.created_at.strftime('%Y-%m-%d %H:%M') }}
                                    </small>
                                    {% if notification.reservation %}
                                    <small class="text-primary me-3">
                                        <i class="fas fa-calendar me-1"></i>
                                        {{ notification.reservation.laboratory.name }}
                                    </small>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="btn-group">
                                {% if not notification.is_read %}
                               <button class="btn btn-sm btn-outline-success" 
                                onclick="markNotificationRead('{{ notification.id }}')"
                                title="Mark as Read">
                            <i class="fas fa-check"></i>
                        </button>

                                {% endif %}
                                {% if notification.reservation %}
                                <a href="{{ url_for('main.schedule') }}?reservation={{ notification.reservation.id }}" 
                                   class="btn btn-sm btn-outline-primary"
                                   title="View Schedule">
                                    <i class="fas fa-eye"></i>
                                </a>
                                {% endif %}
                                <button class="btn btn-sm btn-outline-danger" 
                                onclick="deleteNotification('{{ notification.id }}')" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-bell-slash fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No Notifications</h5>
                    <p class="text-muted">You're all caught up! New notifications will appear here.</p>
                </div>
                {% endif %}
            </div>
        </div>
        {% if notifications %}
        <div class="card-footer">
            <div class="d-flex justify-content-between align-items-center">
                <small class="text-muted">
                    Showing {{ notifications|length }} notifications
                </small>
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline-primary" onclick="loadMoreNotifications()">
                        Load More
                    </button>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Notification Settings -->
    <div class="card mt-4">
        <div class="card-header">
            <h5 class="mb-0">Notification Settings</h5>
        </div>
        <div class="card-body">
            <form id="notificationSettingsForm">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Email Notifications</h6>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="emailReservationApproved" checked>
                            <label class="form-check-label" for="emailReservationApproved">
                                Reservation approved
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="emailReservationRejected" checked>
                            <label class="form-check-label" for="emailReservationRejected">
                                Reservation rejected
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="emailScheduleChanges" checked>
                            <label class="form-check-label" for="emailScheduleChanges">
                                Schedule changes
                            </label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>Push Notifications</h6>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="pushReservationStatus" checked>
                            <label class="form-check-label" for="pushReservationStatus">
                                Reservation status updates
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="pushUpcomingSessions" checked>
                            <label class="form-check-label" for="pushUpcomingSessions">
                                Upcoming sessions
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="pushSystemAlerts">
                            <label class="form-check-label" for="pushSystemAlerts">
                                System alerts
                            </label>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <button type="button" class="btn btn-primary" onclick="saveNotificationSettings()">
                        Save Settings
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Notification Sound Test Modal -->
<div class="modal fade" id="soundTestModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Test Notification Sound</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <i class="fas fa-bell fa-3x text-warning mb-3"></i>
                <p>Click the button below to test the notification sound.</p>
                <button class="btn btn-warning" onclick="testNotificationSound()">
                    <i class="fas fa-volume-up me-1"></i>Play Sound
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Notification management functions
function markNotificationRead(notificationId) {
    fetch(`/notifications/mark_read/${notificationId}`, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const notificationElement = document.querySelector(`[data-notification-id="${notificationId}"]`);
            if (notificationElement) {
                notificationElement.classList.remove('unread');
                notificationElement.querySelector('.fw-bold')?.classList.remove('fw-bold');
                notificationElement.querySelector('.badge')?.remove();
                updateNotificationCount();
                showToast('Success', 'Notification marked as read', 'success');
            }
        }
    })
    .catch(error => {
        console.error('Error marking notification as read:', error);
        showToast('Error', 'Failed to mark notification as read', 'danger');
    });
}

function markAllAsRead() {
    const unreadNotifications = document.querySelectorAll('.notification-item.unread');
    if (unreadNotifications.length === 0) {
        showToast('Info', 'No unread notifications', 'info');
        return;
    }

    if (!confirm(`Mark all ${unreadNotifications.length} notifications as read?`)) {
        return;
    }

    fetch('/notifications/mark_all_read', {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.querySelectorAll('.notification-item.unread').forEach(item => {
                item.classList.remove('unread');
                item.querySelector('.fw-bold')?.classList.remove('fw-bold');
                item.querySelector('.badge')?.remove();
            });
            updateNotificationCount();
            showToast('Success', 'All notifications marked as read', 'success');
        }
    })
    .catch(error => {
        console.error('Error marking all notifications as read:', error);
        showToast('Error', 'Failed to mark all notifications as read', 'danger');
    });
}

function deleteNotification(notificationId) {
    if (!confirm('Are you sure you want to delete this notification?')) {
        return;
    }

    fetch(`/notifications/delete/${notificationId}`, {
        method: 'DELETE',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const notificationElement = document.querySelector(`[data-notification-id="${notificationId}"]`);
            if (notificationElement) {
                notificationElement.remove();
                updateNotificationCount();
                showToast('Success', 'Notification deleted', 'success');
            }
        }
    })
    .catch(error => {
        console.error('Error deleting notification:', error);
        showToast('Error', 'Failed to delete notification', 'danger');
    });
}

function clearAllNotifications() {
    const notificationCount = document.querySelectorAll('.notification-item').length;
    if (notificationCount === 0) {
        showToast('Info', 'No notifications to clear', 'info');
        return;
    }

    if (!confirm(`Are you sure you want to clear all ${notificationCount} notifications? This action cannot be undone.`)) {
        return;
    }

    fetch('/notifications/clear_all', {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('notificationList').innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-bell-slash fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No Notifications</h5>
                    <p class="text-muted">You're all caught up! New notifications will appear here.</p>
                </div>
            `;
            updateNotificationCount();
            showToast('Success', 'All notifications cleared', 'success');
        }
    })
    .catch(error => {
        console.error('Error clearing notifications:', error);
        showToast('Error', 'Failed to clear notifications', 'danger');
    });
}

function refreshNotifications() {
    showLoading('Refreshing notifications...');
    
    fetch('/api/notifications')
        .then(response => response.json())
        .then(data => {
            hideLoading();
            renderNotifications(data.notifications);
            updateNotificationCount();
            showToast('Success', 'Notifications refreshed', 'success');
        })
        .catch(error => {
            hideLoading();
            console.error('Error refreshing notifications:', error);
            showToast('Error', 'Failed to refresh notifications', 'danger');
        });
}

function renderNotifications(notifications) {
    const notificationList = document.getElementById('notificationList');
    
    if (notifications.length === 0) {
        notificationList.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-bell-slash fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No Notifications</h5>
                <p class="text-muted">You're all caught up! New notifications will appear here.</p>
            </div>
        `;
        return;
    }

    let html = '<div class="list-group list-group-flush">';
    
    notifications.forEach(notification => {
        const timeAgo = getTimeAgo(notification.created_at);
        
        html += `
            <div class="list-group-item notification-item ${notification.is_read ? '' : 'unread'}" 
                 data-notification-id="${notification.id}"
                 data-notification-type="${notification.type || 'general'}">
                <div class="d-flex w-100 justify-content-between align-items-start">
                    <div class="flex-grow-1 me-3">
                        <div class="d-flex align-items-center mb-1">
                            <h6 class="mb-0 ${notification.is_read ? '' : 'fw-bold'}">
                                ${notification.title}
                            </h6>
                            ${!notification.is_read ? '<span class="badge bg-warning ms-2">New</span>' : ''}
                        </div>
                        <p class="mb-1 text-muted">${notification.message}</p>
                        <div class="d-flex align-items-center mt-2">
                            <small class="text-muted me-3">
                                <i class="fas fa-clock me-1"></i>${timeAgo}
                            </small>
                            ${notification.reservation_id ? `
                            <small class="text-primary me-3">
                                <i class="fas fa-calendar me-1"></i>Reservation
                            </small>
                            ` : ''}
                        </div>
                    </div>
                    <div class="btn-group">
                        ${!notification.is_read ? `
                        <button class="btn btn-sm btn-outline-success" 
                                onclick="markNotificationRead(${notification.id})"
                                title="Mark as Read">
                            <i class="fas fa-check"></i>
                        </button>
                        ` : ''}
                        ${notification.reservation_id ? `
                        <a href="/schedule?reservation=${notification.reservation_id}" 
                           class="btn btn-sm btn-outline-primary"
                           title="View Schedule">
                            <i class="fas fa-eye"></i>
                        </a>
                        ` : ''}
                        <button class="btn btn-sm btn-outline-danger" 
                                onclick="deleteNotification(${notification.id})"
                                title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    notificationList.innerHTML = html;
}

function updateNotificationCount() {
    const totalCount = document.querySelectorAll('.notification-item').length;
    const unreadCount = document.querySelectorAll('.notification-item.unread').length;
    
    document.getElementById('notificationCount').textContent = 
        `${totalCount} total${unreadCount > 0 ? `, ${unreadCount} unread` : ''}`;
}

function searchNotifications(query) {
    const notifications = document.querySelectorAll('.notification-item');
    const searchTerm = query.toLowerCase();
    
    notifications.forEach(notification => {
        const title = notification.querySelector('h6').textContent.toLowerCase();
        const message = notification.querySelector('p').textContent.toLowerCase();
        
        if (title.includes(searchTerm) || message.includes(searchTerm)) {
            notification.style.display = 'flex';
        } else {
            notification.style.display = 'none';
        }
    });
}

function filterNotifications(filter) {
    const notifications = document.querySelectorAll('.notification-item');
    const filterButtons = document.querySelectorAll('.notification-filter-btn');
    
    // Update active filter button
    filterButtons.forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.filter === filter) {
            btn.classList.add('active');
        }
    });
    
    notifications.forEach(notification => {
        switch(filter) {
            case 'all':
                notification.style.display = 'flex';
                break;
            case 'unread':
                notification.style.display = notification.classList.contains('unread') ? 'flex' : 'none';
                break;
            case 'read':
                notification.style.display = !notification.classList.contains('unread') ? 'flex' : 'none';
                break;
        }
    });
}

function loadMoreNotifications() {
    const currentCount = document.querySelectorAll('.notification-item').length;
    
    showLoading('Loading more notifications...');
    
    fetch(`/api/notifications?offset=${currentCount}&limit=10`)
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.notifications.length > 0) {
                appendNotifications(data.notifications);
                showToast('Success', `Loaded ${data.notifications.length} more notifications`, 'success');
            } else {
                showToast('Info', 'No more notifications to load', 'info');
            }
        })
        .catch(error => {
            hideLoading();
            console.error('Error loading more notifications:', error);
            showToast('Error', 'Failed to load more notifications', 'danger');
        });
}

function appendNotifications(newNotifications) {
    const notificationList = document.querySelector('.list-group');
    
    newNotifications.forEach(notification => {
        const timeAgo = getTimeAgo(notification.created_at);
        
        const notificationHtml = `
            <div class="list-group-item notification-item ${notification.is_read ? '' : 'unread'}" 
                 data-notification-id="${notification.id}"
                 data-notification-type="${notification.type || 'general'}">
                <div class="d-flex w-100 justify-content-between align-items-start">
                    <div class="flex-grow-1 me-3">
                        <div class="d-flex align-items-center mb-1">
                            <h6 class="mb-0 ${notification.is_read ? '' : 'fw-bold'}">
                                ${notification.title}
                            </h6>
                            ${!notification.is_read ? '<span class="badge bg-warning ms-2">New</span>' : ''}
                        </div>
                        <p class="mb-1 text-muted">${notification.message}</p>
                        <div class="d-flex align-items-center mt-2">
                            <small class="text-muted me-3">
                                <i class="fas fa-clock me-1"></i>${timeAgo}
                            </small>
                            ${notification.reservation_id ? `
                            <small class="text-primary me-3">
                                <i class="fas fa-calendar me-1"></i>Reservation
                            </small>
                            ` : ''}
                        </div>
                    </div>
                    <div class="btn-group">
                        ${!notification.is_read ? `
                        <button class="btn btn-sm btn-outline-success" 
                                onclick="markNotificationRead(${notification.id})"
                                title="Mark as Read">
                            <i class="fas fa-check"></i>
                        </button>
                        ` : ''}
                        ${notification.reservation_id ? `
                        <a href="/schedule?reservation=${notification.reservation_id}" 
                           class="btn btn-sm btn-outline-primary"
                           title="View Schedule">
                            <i class="fas fa-eye"></i>
                        </a>
                        ` : ''}
                        <button class="btn btn-sm btn-outline-danger" 
                                onclick="deleteNotification(${notification.id})"
                                title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        notificationList.insertAdjacentHTML('beforeend', notificationHtml);
    });
    
    updateNotificationCount();
}

function saveNotificationSettings() {
    const settings = {
        emailReservationApproved: document.getElementById('emailReservationApproved').checked,
        emailReservationRejected: document.getElementById('emailReservationRejected').checked,
        emailScheduleChanges: document.getElementById('emailScheduleChanges').checked,
        pushReservationStatus: document.getElementById('pushReservationStatus').checked,
        pushUpcomingSessions: document.getElementById('pushUpcomingSessions').checked,
        pushSystemAlerts: document.getElementById('pushSystemAlerts').checked
    };
    
    showLoading('Saving settings...');
    
    fetch('/api/notifications/settings', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(settings)
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            showToast('Success', 'Notification settings saved', 'success');
        } else {
            showToast('Error', 'Failed to save settings', 'danger');
        }
    })
    .catch(error => {
        hideLoading();
        console.error('Error saving notification settings:', error);
        showToast('Error', 'Failed to save settings', 'danger');
    });
}

function testNotificationSound() {
    if (window.notificationSystem) {
        window.notificationSystem.playNotificationSound();
        showToast('Success', 'Notification sound played', 'success');
    }
}

function getTimeAgo(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffInSeconds = Math.floor((now - date) / 1000);
    
    if (diffInSeconds < 60) {
        return 'Just now';
    } else if (diffInSeconds < 3600) {
        const minutes = Math.floor(diffInSeconds / 60);
        return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
    } else if (diffInSeconds < 86400) {
        const hours = Math.floor(diffInSeconds / 3600);
        return `${hours} hour${hours > 1 ? 's' : ''} ago`;
    } else if (diffInSeconds < 2592000) {
        const days = Math.floor(diffInSeconds / 86400);
        return `${days} day${days > 1 ? 's' : ''} ago`;
    } else {
        return date.toLocaleDateString();
    }
}

// Initialize notification system
document.addEventListener('DOMContentLoaded', function() {
    updateNotificationCount();
    
    // Request notification permission
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
    }
});
</script>

<style>
.notification-item.unread {
    background-color: #f8f9fa;
    border-left: 4px solid #ffc107;
}

.notification-item {
    border-left: 4px solid transparent;
    transition: all 0.2s ease;
}

.notification-item:hover {
    background-color: #e9ecef;
}

.list-group-item {
    border: none;
    border-bottom: 1px solid #dee2e6;
}

.list-group-item:last-child {
    border-bottom: none;
}

.btn-group .btn {
    padding: 0.25rem 0.5rem;
}
</style>